<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="never">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="乱码三千 – 分享实用IT技术" type="application/atom+xml">






<meta name="description" content="android程序员一枚,擅长java,kotlin,python,金融投资,欢迎交流~">
<meta name="keywords" content="android,java,kotlin,golang,go,python,自动化,量化,金融,php,docker,linux">
<meta property="og:type" content="website">
<meta property="og:title" content="乱码三千 – 分享实用IT技术">
<meta property="og:url" content="https://code.newban.cn/index.html">
<meta property="og:site_name" content="乱码三千 – 分享实用IT技术">
<meta property="og:description" content="android程序员一枚,擅长java,kotlin,python,金融投资,欢迎交流~">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="乱码三千 – 分享实用IT技术">
<meta name="twitter:description" content="android程序员一枚,擅长java,kotlin,python,金融投资,欢迎交流~">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<!--谷歌广告验证代码-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-2626449904708114",
          enable_page_level_ads: true
     });
</script>
<!--谷歌广告验证代码-->

<!--短链广告-->
<!--<script type="text/javascript">
    var adfly_id = 25792435;
    var adfly_advert = 'banner';
    var popunder = false;
    var exclude_domains = ['code.newban.cn','newban.cn',  'localhost:4000'];
</script>
<script src="https://cdn.adf.ly/js/link-converter.js"></script>-->
<!--短链广告-->



  <link rel="canonical" href="https://code.newban.cn/">





  <title>乱码三千 – 分享实用IT技术</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>
  
<a href="https://www.github.com/songjianzaina" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">乱码三千 – 分享实用IT技术</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">乱码三千 – 码出一个新世界</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="http://www.newban.cn/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://code.newban.cn/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://code.newban.cn469.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="乱码三千">
      <meta itemprop="description" content>
      <meta itemprop="image" content="images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="乱码三千 – 分享实用IT技术">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="469.html" itemprop="url">编写一个hexo插件 实现将博客中的原创文章同步到微信公众号</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-04-19T10:14:19+08:00">
                2024-04-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这个需求很早以前就有了 由于各种原因耽搁了  这次准备把这个功能搞定</p>
<p>我的大本营在博客上 微信公众号只是附带 不过考虑到微信搜索流量以及公众号的广告收益 所以 还等什么呢 自动化地搞起来 嘿嘿😜</p>
<h2 id="功能实现流程"><a href="#功能实现流程" class="headerlink" title="功能实现流程"></a>功能实现流程</h2><p>流程如下:</p>
<ol>
<li>在执行<code>hexo d</code>指令是 获取所有文章<code>html</code></li>
<li>将内容中带有<code>本文为作者原创</code>的文章过滤出来 并排除<code>wx_pushed.txt</code>中已经同步的文章</li>
<li>替换文章中的图片</li>
<li>增加封面图</li>
<li>替换内链样式</li>
<li>推送文章到公众号</li>
<li>推送成功后将文章文件名称记录到<code>wx_pushed.txt</code>中 防止后面重复推送</li>
</ol>
<h2 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h2><p>插件代码如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hexo-wx-sync.js 自动将hexo博客中的原创文章同步到微信公众号</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">'axios'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; log &#125; = <span class="built_in">require</span>(<span class="string">'console'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> cheerio = <span class="built_in">require</span>(<span class="string">'cheerio'</span>);</span><br><span class="line"><span class="keyword">var</span> req = <span class="built_in">require</span>(<span class="string">'request-promise'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PLUGIN_NAME = <span class="string">'hexo-wx-sync'</span>;</span><br><span class="line"><span class="keyword">const</span> PUSHED_ARTICLES_FILE = <span class="string">'wx_pushed.txt'</span>;</span><br><span class="line"><span class="keyword">const</span> config = hexo.config.wx_sync</span><br><span class="line"><span class="keyword">const</span> parentDir = path.dirname(__dirname);<span class="comment">//当前文件的父目录 也就是hexo</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在执行 hexo d 时触发</span></span><br><span class="line">hexo.extend.generator.register(<span class="string">'wechat'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">locals</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//获取微信公众号accesToken</span></span><br><span class="line">   accessToken=getAccessToken()</span><br><span class="line">  <span class="comment">// 获取所有文章</span></span><br><span class="line">  <span class="keyword">const</span> posts = locals.posts;</span><br><span class="line">  <span class="comment">// 遍历所有文章</span></span><br><span class="line">  posts.forEach(<span class="keyword">async</span> post =&gt; &#123;<span class="comment">//post.content 获取的是html格式内容</span></span><br><span class="line">    <span class="comment">// 获取文章路径</span></span><br><span class="line">    <span class="keyword">const</span> postPath = parentDir + <span class="string">"/source/"</span> + post.source;</span><br><span class="line">    <span class="comment">// 读取markdown文章内容</span></span><br><span class="line">    <span class="keyword">const</span> content = fs.readFileSync(postPath, <span class="string">'utf8'</span>);</span><br><span class="line">    <span class="comment">// 过滤符合条件的文章并替换内容</span></span><br><span class="line">    <span class="keyword">const</span> filteredContent = <span class="keyword">await</span> filterAndReplaceContent(post.content);</span><br><span class="line">    <span class="comment">// 增加封面图</span></span><br><span class="line">     <span class="keyword">const</span> coverImageId = <span class="keyword">await</span> addCoverImage(<span class="string">"https://source.unsplash.com/900x400/?book,library"</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"准备发布"</span> + content)</span><br><span class="line">    <span class="comment">// 调用微信接口发布文章</span></span><br><span class="line">    publishToWechat(content, post, coverImageId);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">filterAndReplaceContent</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 使用 cheerio 解析 HTML 内容</span></span><br><span class="line">  <span class="keyword">const</span> $ = cheerio.load(<span class="string">`&lt;article&gt;<span class="subst">$&#123;content&#125;</span>&lt;/article&gt;`</span>);</span><br><span class="line">  <span class="comment">// 过滤带有'本文为作者原创'的文章 closest表示查找当前元素最近的祖元素</span></span><br><span class="line">  <span class="keyword">const</span> filteredContent = $(<span class="string">'p:contains("本文为作者原创")'</span>).closest(<span class="string">'article'</span>).html();</span><br><span class="line">  <span class="comment">// 替换文章中的图片和内链样式</span></span><br><span class="line">  <span class="comment">// 这里假设你已经实现了相应的函数，比如 replaceImages 和 replaceInternalLinks</span></span><br><span class="line">  <span class="keyword">const</span> replacedContent = <span class="keyword">await</span> replaceImages(filteredContent);</span><br><span class="line">  <span class="keyword">const</span> finalContent = <span class="keyword">await</span> replaceInternalLinks(replacedContent);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"文章过滤完成"</span>)</span><br><span class="line">  <span class="keyword">return</span> finalContent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">publishToWechat</span>(<span class="params">parsedContent, metadata, coverImageId</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  axios.post(<span class="string">`https://api.weixin.qq.com/cgi-bin/draft/add?access_token=<span class="subst">$&#123;accessToken&#125;</span>`</span>, &#123;</span><br><span class="line">    articles: [&#123;</span><br><span class="line">      title: <span class="string">`<span class="subst">$&#123;metadata.title&#125;</span> `</span>,</span><br><span class="line">      thumb_media_id: coverImageId, <span class="comment">// 刚才取到的封面图素材 id</span></span><br><span class="line">      author: <span class="string">'乱码三千'</span>,</span><br><span class="line">      digest: metadata.title,</span><br><span class="line">      content: parsedContent, <span class="comment">// 刚才处理好的文章</span></span><br><span class="line">      content_source_url: <span class="string">`http://code.newban.cn/463.html`</span>, <span class="comment">// 非必填，这里我写的是我博客这篇文章的 URL</span></span><br><span class="line">      need_open_comment: <span class="number">1</span>, <span class="comment">// 是否打开留言功能</span></span><br><span class="line">      show_cover_pic: <span class="number">0</span>, <span class="comment">// 是否把封面图添加到文章开头</span></span><br><span class="line">    &#125;],</span><br><span class="line">  &#125;).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//推送成功会返回一个media_id </span></span><br><span class="line">    da = response.data</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'media_id'</span> <span class="keyword">in</span> da) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;metadata.title&#125;</span> successfully pushed to WeChat.`</span>);</span><br><span class="line">      <span class="comment">// 记录已推送的文章名称到 wx_pushed.txt 文件中</span></span><br><span class="line">      fs.appendFileSync(PUSHED_ARTICLES_FILE, <span class="string">`<span class="subst">$&#123;metadata.source.replace(<span class="string">"_post/"</span>, <span class="string">""</span>).replace(<span class="string">"md"</span>, <span class="string">"html"</span>)&#125;</span>\n`</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(da)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;).catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">`Failed to push <span class="subst">$&#123;metadata.title&#125;</span> to WeChat: <span class="subst">$&#123;error&#125;</span>`</span>);</span><br><span class="line">  &#125;);;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换文章中的图片</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">replaceImages</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"开始替换图片"</span>)</span><br><span class="line">  <span class="keyword">const</span> $ = cheerio.load(content);</span><br><span class="line">  $(<span class="string">'img'</span>).each(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> newUrl = <span class="keyword">await</span> uploadImg($(<span class="keyword">this</span>).attr(<span class="string">'src'</span>));</span><br><span class="line">    $(<span class="keyword">this</span>).attr(<span class="string">'src'</span>, newUrl);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"图片替换完成"</span>)</span><br><span class="line">  <span class="keyword">return</span> $.html();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">request</span>(<span class="params">option</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> req(option).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"请求成功: "</span> + response);</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line">  &#125;).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"请求错误: "</span> + err);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&#123;"media_id":"fTLNXU-IBCWKkfWOlCRS17gXwNG5_75-7aBJQalLz1BBBE5UJ43cj3JfxCyYiTN-"&#125;'</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传图片到素材库并获取新的图片地址</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">uploadImg</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"需要上传的图片地址:"</span> + url)</span><br><span class="line">  <span class="keyword">const</span> imageStream = (<span class="keyword">await</span> axios.get(url, &#123; <span class="attr">responseType</span>: <span class="string">'stream'</span> &#125;)).data;</span><br><span class="line">  <span class="keyword">const</span> formData = &#123; <span class="attr">media</span>: imageStream &#125;;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> request(&#123;</span><br><span class="line">    url: <span class="string">`https://api.weixin.qq.com/cgi-bin/media/uploadimg?access_token=<span class="subst">$&#123;accessToken&#125;</span>`</span>,</span><br><span class="line">    method: <span class="string">'POST'</span>,</span><br><span class="line">    formData,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">JSON</span>.parse(res).url;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">addCoverImage</span>(<span class="params">coverImage</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 实现封面图增加逻辑</span></span><br><span class="line">  <span class="keyword">const</span> coverImageStream = (<span class="keyword">await</span> axios.get(coverImage, &#123; <span class="attr">responseType</span>: <span class="string">'stream'</span> &#125;)).data;</span><br><span class="line">  <span class="keyword">const</span> coverImageRes = <span class="keyword">await</span> request(&#123;</span><br><span class="line">    url: <span class="string">`https://api.weixin.qq.com/cgi-bin/material/add_material?access_token=<span class="subst">$&#123;accessToken&#125;</span>&amp;type=image`</span>,</span><br><span class="line">    method: <span class="string">'POST'</span>,</span><br><span class="line">    formData: &#123; <span class="attr">media</span>: coverImageStream &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> coverImageId = <span class="built_in">JSON</span>.parse(coverImageRes).media_id;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"封面图id:"</span> + coverImageId)</span><br><span class="line">  <span class="keyword">return</span> coverImageId;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAccessToken</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> axios.get(<span class="string">`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=<span class="subst">$&#123;config.appid&#125;</span>&amp;secret=<span class="subst">$&#123;config.secret&#125;</span>`</span>).then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (res.status !== <span class="number">200</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res.data.access_token;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;).catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">`获取accesToken失败`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用方法:</strong></p>
<p>在<code>script</code>目录下新建一个<code>自定义名称.js</code>文件,  注意名称不要使用<code>index.js</code>, 将上面代码粘贴过去, 然后在<code>config</code>配置文件中配置<code>AppID</code>和<code>AppSecret</code> 如下:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将文章同步到微信公众号</span></span><br><span class="line"><span class="attr">wx_sync:</span></span><br><span class="line"><span class="attr">    enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    appid:</span> <span class="string">你的appid</span></span><br><span class="line"><span class="attr">    secret:</span> <span class="string">你的secret</span></span><br></pre></td></tr></table></figure>

<h2 id="关于AppID和AppSecret的获取"><a href="#关于AppID和AppSecret的获取" class="headerlink" title="关于AppID和AppSecret的获取"></a>关于AppID和AppSecret的获取</h2><p>开发者ID(<code>AppID</code>)和开发者密码(<code>AppSecret</code>)可以在公众号后台基本配置中获取:</p>
<p><img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240419133336814.png" alt="image-20240419133336814"></p>
<p><img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240419133636776.png" alt="image-20240419133636776"></p>
<p>为了确保接口能正常访问, 还需要设置接口请求所在地的ip地址, 如果你在阿里云服务器调用这些接口 则填入服务器的<code>ip</code> , 如果是本地电脑 则在百度搜索IP获取当前公网IP:</p>
<p><img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240419134212591.png" alt="image-20240419134212591"></p>
<p><img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240419133544001.png" alt="image-20240419133544001"></p>
<p>文章参考 : 《<a href="https://code.newban.cn/468.html">博客文章自动同步微信公众号实践</a>》</p>
<p><strong>本文为作者原创 转载时请注明出处 谢谢</strong></p>
<p><img src="https://gitee.com/songjianzaina/SavePicGoPic/raw/master/img/20191119095516.png" alt></p>
<p><em><a href="https://code.newban.cn/">乱码三千 – 点滴积累 ,欢迎来到乱码三千技术博客站</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://code.newban.cn468.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="乱码三千">
      <meta itemprop="description" content>
      <meta itemprop="image" content="images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="乱码三千 – 分享实用IT技术">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="468.html" itemprop="url">博客文章自动同步微信公众号实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-04-17T12:14:19+08:00">
                2024-04-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文来自 zhiyi 的个人博客实践，可以通过开放能力将其他平台的文章同步到微信公众号上，对刚学前端的同学（有自己的博客就更好了）来说，是对后台接口链路的一个不错的探索。</p>
<h3 id="整体思路"><a href="#整体思路" class="headerlink" title="整体思路"></a>整体思路</h3><p>微信官方提供了素材管理的 API，通过 API 可以很方便地进行同步。在使用 API 之前需要进行鉴权，所以需要先获取 access token。微信公众号中不允许出现外域图片，因此需要把文章里的图片全部使用微信的图片上传接口处理后替换。此外，微信公众号支持 HTML 标签但是只支持内联样式，所以必须把外联样式全部转换为内联样式。</p>
<p>所以，同步到微信公众号的操作，需要按照以下步骤：</p>
<ol>
<li>使用公众号的 appid 和 secret 换取 access token。</li>
<li>把文章中的所有图片用微信图片上传接口上传，并替换文章里的 URL。这一步需要使用 access token 鉴权。</li>
<li>将文章中的所有外联 css 转为内联样式。</li>
<li>调用微信素材管理接口，同步文章。这里需要使用 access token 鉴权。</li>
</ol>
<h3 id="获取-access-token"><a href="#获取-access-token" class="headerlink" title="获取 access token"></a>获取 access token</h3><p>获取 access token 本身没什么难度，使用微信公众号的 appid 和 secret 就可以从接口获取到。需要注意的是，这个接口有调用频率限制，短时间内调用次数不能过多。</p>
<p>所以我们从微信的接口获取 access token 之后应该将它缓存，之后直接从缓存中获取，缓存失效了再重新从接口获取。这里的缓存机制使用了 Redis，因为 Redis 提供的过期失效机制正好满足我们的需求。</p>
<p>首先我们在 Koa 的全局变量里注册 Redis，以便在各种场景调用。这里，我们把它写成 Koa 中间件的形式，并把几个 Redis 常用操作 Promise 化。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">redisConfig</span>) =&gt;</span><span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> client = redis.createClient(redisConfig.port, redisConfig.host);</span><br><span class="line">  client.auth(redisConfig.password);</span><br><span class="line">  ctx.redis = &#123;</span><br><span class="line">    <span class="keyword">get</span>: (key) =&gt; new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">      client.get(key, (err, result) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          reject(err);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          resolve(result);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">set</span>: (key, value) =&gt; new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">      client.set(key, value, (err, result) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          reject(err);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          resolve(result);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;),</span><br><span class="line">    expire: <span class="function">(<span class="params">key, expire</span>) =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      client.expire(key, expire, (err, result) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          reject(err);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          resolve(result);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;),</span><br><span class="line">    del: <span class="function">(<span class="params">key</span>) =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      client.del(key, (err, result) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          reject(err);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          resolve(result);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">await</span> next();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>之后，在获取<code>access token</code> 时，先尝试从<code>Redis</code>中取。如果获取到了，就直接返回结果；如果没取到，就向微信接口请求并写入 Redis。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> accessToken = <span class="keyword">await</span> ctx.redis.get(<span class="string">'wechatAccessToken'</span>);</span><br><span class="line">    <span class="keyword">if</span> (!accessToken) &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> axios.get(<span class="string">`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=<span class="subst">$&#123;wechatConfig.appid&#125;</span>&amp;secret=<span class="subst">$&#123;wechatConfig.secret&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">if</span> (res?.status !== <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'get access token error'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      accessToken = res?.data?.access_token;</span><br><span class="line">      <span class="keyword">const</span> expiresIn = res?.data?.expires_in;</span><br><span class="line">      <span class="keyword">if</span> (!accessToken) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'get access token error'</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> ctx.redis.set(<span class="string">'wechatAccessToken'</span>, accessToken);</span><br><span class="line">        <span class="keyword">await</span> ctx.redis.expire(<span class="string">'wechatAccessToken'</span>, expiresIn);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(accessToken);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这样，我们就实现了获取并缓存<code>access token</code>。</p>
<h3 id="上传并替换图片"><a href="#上传并替换图片" class="headerlink" title="上传并替换图片"></a>上传并替换图片</h3><p>我的文章内容是一段 HTML 代码字符串，这是由前端传入的。不管前端使用什么编辑器，这一步都需要先转为 HTML 字符串再操作。</p>
<p>首先需要把文章内容中的图片全部找出来，这里直接用正则即可：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> images = parsedContent.match(<span class="regexp">/&lt;img.*?(?:&gt;|\/&gt;)/gi</span>);</span><br><span class="line"><span class="keyword">if</span> (images) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> image <span class="keyword">of</span> images) &#123;</span><br><span class="line">    <span class="keyword">const</span> src = image.match(<span class="regexp">/src=['"]?([^'"]*)['"]?/i</span>);</span><br><span class="line">    <span class="keyword">const</span> url = src?.[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">// 对取出的 URL 做处理</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先匹配所有的 <code>&lt;img /&gt;</code> 标签，之后针对每个标签再做一次匹配，取到其中的 src 值（也就是图片的 URL）。</p>
<p>对匹配到的图片 URL 依次下载为 stream 并上传到微信公众号图片上传接口，之后使用返回的微信域内 URL 替换原文中的 URL。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (url) &#123;</span><br><span class="line">  <span class="keyword">const</span> imageStream = (<span class="keyword">await</span> axios.get(url, &#123; <span class="attr">responseType</span>: <span class="string">'stream'</span> &#125;)).data;</span><br><span class="line">  <span class="keyword">const</span> formData = &#123; <span class="attr">media</span>: imageStream &#125;;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> request(&#123;</span><br><span class="line">    url: <span class="string">`https://api.weixin.qq.com/cgi-bin/media/uploadimg?access_token=<span class="subst">$&#123;accessToken&#125;</span>`</span>,</span><br><span class="line">    method: <span class="string">'POST'</span>,</span><br><span class="line">    formData,</span><br><span class="line">  &#125;);</span><br><span class="line">  parsedContent = parsedContent.replace(url, <span class="built_in">JSON</span>.parse(res).url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上传图片的接口当然需要鉴权，这里的 access token 是直接使用上一步封装好的方法获取的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> accessToken = <span class="keyword">await</span> getWechatAccessToken(ctx);</span><br></pre></td></tr></table></figure>

<p>需要注意的是，上传到微信公众号必须使用 request 或者基于 request 的 request-promise。因为 node 环境的 axios 对 form-data 格式发送文件的 POST 并不能很好地支持。</p>
<p>不要忘记了对封面图也做一样的处理，因为使用 API 编辑公众号图文必须添加封面图，封面图也必须是微信域内的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> coverImageStream = (<span class="keyword">await</span> axios.get(coverImage, &#123; <span class="attr">responseType</span>: <span class="string">'stream'</span> &#125;)).data;</span><br><span class="line"><span class="keyword">const</span> coverImageRes = <span class="keyword">await</span> request(&#123;</span><br><span class="line">  url: <span class="string">`https://api.weixin.qq.com/cgi-bin/material/add_material?access_token=<span class="subst">$&#123;accessToken&#125;</span>&amp;type=image`</span>,</span><br><span class="line">  method: <span class="string">'POST'</span>,</span><br><span class="line">  formData: &#123; <span class="attr">media</span>: coverImageStream &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> coverImageId = <span class="built_in">JSON</span>.parse(coverImageRes).media_id;</span><br></pre></td></tr></table></figure>

<p>这里需要注意的是，上传封面图的接口和上传图片的接口是不一样的，要注意区分。最后我们拿到的是封面图的素材 id，这个 id 我们后面创建图文素材时会用到。</p>
<p>把封面图和文章中的图片都替换一遍后，我们就完成了这一步。</p>
<h3 id="外联-CSS-转为内联"><a href="#外联-CSS-转为内联" class="headerlink" title="外联 CSS 转为内联"></a>外联 CSS 转为内联</h3><p>这一步我本来以为会很麻烦，但是幸运的是，在 node 上（前端浏览器等环境不可以用这个包，会报错）有一个名为 <a href="https://mp.weixin.qq.com/s/mZeuVB6lpXQ1yKNULeG5tw" target="_blank" rel="noopener">juice</a> 的 npm 包可以帮我们一行代码完成任务：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">parsedContent = juice(<span class="string">`</span></span><br><span class="line"><span class="string">  &lt;style&gt;</span></span><br><span class="line"><span class="string">    <span class="subst">$&#123;cssString&#125;</span></span></span><br><span class="line"><span class="string">  &lt;/style&gt;</span></span><br><span class="line"><span class="string">  &lt;div&gt;</span></span><br><span class="line"><span class="string">    <span class="subst">$&#123;parsedContent&#125;</span></span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">`</span>);</span><br></pre></td></tr></table></figure>

<p>这里的 <code>cssString</code> 是定义好的字符串，事先把需要应用的 CSS 代码定义好一个字符串变量即可；第一个参数则是需要处理的 HTML 代码，也就是上一步替换图片 URL 的结果。</p>
<h3 id="调用接口创建素材"><a href="#调用接口创建素材" class="headerlink" title="调用接口创建素材"></a>调用接口创建素材</h3><p>到这一步已经没什么问题了，按照微信开发文档调用接口即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> axios.post(<span class="string">`https://api.weixin.qq.com/cgi-bin/draft/add?access_token=<span class="subst">$&#123;accessToken&#125;</span>`</span>, &#123;</span><br><span class="line">  articles: [&#123;</span><br><span class="line">    title: <span class="string">'你的文章标题'</span>,</span><br><span class="line">    thumb_media_id: coverImageId, <span class="comment">// 刚才取到的封面图素材 id</span></span><br><span class="line">    author: <span class="string">'文章作者'</span>,</span><br><span class="line">    digest: <span class="string">'文章摘要'</span>,</span><br><span class="line">    content: parsedContent, <span class="comment">// 刚才处理好的文章</span></span><br><span class="line">    content_source_url: <span class="string">'原文链接'</span>, <span class="comment">// 非必填，这里我写的是我博客这篇文章的 URL</span></span><br><span class="line">    need_open_comment: <span class="number">1</span>, <span class="comment">// 是否打开留言功能</span></span><br><span class="line">    show_cover_pic: <span class="number">0</span>, <span class="comment">// 是否把封面图添加到文章开头</span></span><br><span class="line">  &#125;],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这样就可以成功把文章同步到微信公众号后台的素材库中。最后在微信公众号官方客户端 “订阅号助手” 操作一下，就可以成功把文章发布出去了。当然，最后的发布操作也可以调用 API 解决，不过官方客户端本身就有这个功能，而且官方客户端的 “预览” 功能可以让我提前看到效果，所以我就不必多此一举了。</p>
<h3 id="尚未解决的小问题"><a href="#尚未解决的小问题" class="headerlink" title="尚未解决的小问题"></a>尚未解决的小问题</h3><p>虽然同步到微信公众号这个功能帮我打通了在手机上创作到发布的整个链路，但是还是有两个小问题暂时没法解决：</p>
<ol>
<li>微信公众号未提供声明原创的接口，官方客户端也没有这个功能，因此想要声明原创文章还是必须在电脑上操作。</li>
<li>微信公众号网页版管理后台支持对封面图进行自定义裁剪，而通过 API 指定封面图则只能使用图片中间部分。</li>
</ol>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html" target="_blank" rel="noopener">微信公众号开发文档</a></p>
<p><strong>本文转载自:</strong> <a href="https://mp.weixin.qq.com/s/mZeuVB6lpXQ1yKNULeG5tw" target="_blank" rel="noopener">微信公众号</a></p>
<p><img src="https://gitee.com/songjianzaina/SavePicGoPic/raw/master/img/20191119095516.png" alt></p>
<p><em><a href="https://code.newban.cn/">乱码三千 – 点滴积累 ,欢迎来到乱码三千技术博客站</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://code.newban.cn466.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="乱码三千">
      <meta itemprop="description" content>
      <meta itemprop="image" content="images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="乱码三千 – 分享实用IT技术">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="466.html" itemprop="url">2024年关于新浪图床失效的解决方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-04-17T10:14:19+08:00">
                2024-04-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>很多早期的站长基本使用新浪的图床, 新浪图床免费又稳定, 受到很多人的青睐, 我本人不怎么用新浪图床, 但是手上有一批素材, 引用的是新浪服务器中的图片, 目前这些图片无论是在浏览器还是在<code>Markdown</code>编辑器中都无法显示</p>
<p><img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240417181012252.png" alt="image-20240417181012252"></p>
<p><img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240417181029759.png" alt="image-20240417181029759"></p>
<p>这已经不是简单的防盗链了 应该是新浪服务器做了某种屏蔽处理</p>
<h2 id="检测服务器和链接是否正常"><a href="#检测服务器和链接是否正常" class="headerlink" title="检测服务器和链接是否正常"></a>检测服务器和链接是否正常</h2><p>首先我们要确保新浪服务器中有该图片文件,  可以通过以下几种方式检测:</p>
<ol>
<li><p>用<code>VScode</code>编辑器中打开文档 然后鼠标停留在图片链接上, 如果能显示图片, 说明该链接有效</p>
<p> <img src="https://gitee.com/songjianzaina/site_img/raw/master/img/2024-04-17%2018-02-18.2024-04-17%2018_02_58.gif" alt="2024-04-17 18-02-18.2024-04-17 18_02_58"></p>
</li>
<li><p>用<code>PostMan</code>或者<code>ApiPost</code>进行请求访问<br> <img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240417181652619.png" alt="image-20240417181652619"></p>
</li>
<li><p>使用下载工具进行下载</p>
<p> <img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240417181820927.png" alt="image-20240417181820927"></p>
</li>
</ol>
<p>值得庆幸的是 新浪服务器还没有挂 我们还有足够的时间来对图片进行转移和备份</p>
<h2 id="防盗链临时解决方法"><a href="#防盗链临时解决方法" class="headerlink" title="防盗链临时解决方法"></a>防盗链临时解决方法</h2><p>为了使图片迅速恢复访问, 我们可以使用第三方缓存服务来解决防盗链问题, 有以下四种方式可行:</p>
<ol>
<li><p><strong>WordPress</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://i0.wp.com/图片地址（图片地址要掉 https://）</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Weserv.nl</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://images.weserv.nl/?url=图片地址</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>百度 1：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://image.baidu.com/search/down?url=图片地址</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>百度 2</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://gimg2.baidu.com/image_search/&amp;app=2020&amp;src=图片地址（图片地址要去掉 https://）</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>使用百度的速度相对快一些</p>
<h2 id="Wordpress批量替换"><a href="#Wordpress批量替换" class="headerlink" title="Wordpress批量替换"></a>Wordpress批量替换</h2><p>如果你的<code>wordpress</code>博客大量的图片都在新浪中, 那么可以通过以下两种方式进行批量替换:</p>
<ol>
<li><p><strong>静态替换 修改数据库</strong></p>
<p>修改数据库之前记得先备份数据库 以防止误操作无法还原</p>
<p><code>sql</code>命令如下:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> wp_posts <span class="keyword">SET</span> post_content = <span class="keyword">REPLACE</span>( post_content,  <span class="string">'https://tvax1.sinaimg.cn/'</span>,  <span class="string">'https://image.baidu.com/search/down?url=https://tvax1.sinaimg.cn/'</span> )</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>动态替换 修改主题代码</strong></p>
<p>进入<code>wordpress</code>主题编辑器:</p>
<p><img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240417185327043.png" alt="image-20240417185327043"></p>
<p>将以下代码添加到主题页脚<code>foot.php</code>中:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"> <span class="keyword">let</span> context = <span class="built_in">Array</span>.prototype.map.call(<span class="built_in">document</span>.images, (event) =&gt; &#123;</span></span><br><span class="line"><span class="actionscript">           event.src = event.src.replace(<span class="string">"tvax1.sinaimg.cn/"</span>, <span class="string">"image.baidu.com/search/down?url=https://tvax1.sinaimg.cn/"</span>)</span></span><br><span class="line">          </span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240417185632599.png" alt="image-20240417185632599"></p>
</li>
</ol>
<p>推荐使用动态的方式自动批量替换, 能将降低数据库操作风险, 又方便后期再次更改, 动态的方式唯一不足之处就是图片加载有延迟</p>
<p>如果你追求加载速度和用户体验, 那么建议采用静态替换的方式</p>
<h2 id="图片批量备份"><a href="#图片批量备份" class="headerlink" title="图片批量备份"></a>图片批量备份</h2><p>上面这种临时替换方式始终不是长久之计, 我们需要尽快对图片进行备份和迁移  防止新浪图床哪天不再提供服务了</p>
<p>我个人的做法是通过<code>python</code>批量将图片下载到本地 然后进行图床更换, 核心代码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="comment"># 当前文件路径</span></span><br><span class="line">current_path = os.path.abspath(__file__)</span><br><span class="line"><span class="comment"># 父目录</span></span><br><span class="line">father_path = os.path.abspath(os.path.dirname(current_path) + os.path.sep + <span class="string">"."</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#----- 用于图片下载------</span></span><br><span class="line">opener=urllib.request.build_opener()</span><br><span class="line">opener.addheaders=[(<span class="string">'User-Agent'</span>,<span class="string">'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1941.0 Safari/537.36'</span>),(<span class="string">'Accept'</span>			, <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'</span>),(</span><br><span class="line">        <span class="string">'Accept-Encoding'</span>	, <span class="string">'gzip,deflate,sdch'</span>),</span><br><span class="line">        (<span class="string">'Accept-Language'</span>	, <span class="string">'zh-CN,zh;q=0.8'</span>)]</span><br><span class="line">req=urllib.request</span><br><span class="line">req.install_opener(opener)</span><br><span class="line"><span class="comment">#----- 用于图片下载------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 图片输出目录</span></span><br><span class="line">pic_dir = <span class="string">'img'</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(pic_dir):</span><br><span class="line">    os.makedirs(pic_dir)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#将网络图片下载到本地</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_img</span><span class="params">(url,dir,image_name)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        req.urlretrieve(url, dir+image_name)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#采用原图片地址的名称</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pic_name_by_url</span><span class="params">(url)</span>:</span></span><br><span class="line">     <span class="comment"># 我只需要末尾xxx部分 使用正则替换</span></span><br><span class="line">    image_name = url.split(<span class="string">'/'</span>)[<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">return</span> image_name</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">img2url</span><span class="params">(url)</span>:</span></span><br><span class="line">    		 fir=<span class="string">"https://cdn.jsdelivr.net/gh/xxx/xxx/img/"</span></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">if</span> <span class="string">"sinaimg.cn"</span> <span class="keyword">in</span> url:</span><br><span class="line">        url=<span class="string">"https://image.baidu.com/search/down?url="</span>+url</span><br><span class="line">    new_name=get_pic_name_by_url(url)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        download_img(url,<span class="string">"&#123;parent&#125;/img/"</span>.format(parent=father_path),new_name)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">f"图片下载异常: <span class="subst">&#123;e&#125;</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> url</span><br><span class="line">    <span class="keyword">return</span> fir+new_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历每篇文章</span></span><br><span class="line"><span class="keyword">for</span> idx, post <span class="keyword">in</span> enumerate(posts):</span><br><span class="line">    content, lastmodifytime = post</span><br><span class="line"></span><br><span class="line">    d=pq(content)</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> d(<span class="string">"img"</span>).items():</span><br><span class="line">        old_url=item.attr(<span class="string">"src"</span>)</span><br><span class="line">        <span class="comment"># 将图片下载到本地</span></span><br><span class="line">        new_url=img2url(old_url)</span><br><span class="line">        print(new_url)</span><br><span class="line">        <span class="comment">#替换图片地址</span></span><br><span class="line">        item.attr(<span class="string">"src"</span>,new_url)</span><br></pre></td></tr></table></figure>

<p><strong>本文为作者原创 转载时请注明出处 谢谢</strong></p>
<p><img src="https://gitee.com/songjianzaina/SavePicGoPic/raw/master/img/20191119095516.png" alt></p>
<p><em><a href="https://code.newban.cn/">乱码三千 – 点滴积累 ,欢迎来到乱码三千技术博客站</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://code.newban.cn467.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="乱码三千">
      <meta itemprop="description" content>
      <meta itemprop="image" content="images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="乱码三千 – 分享实用IT技术">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="467.html" itemprop="url">内容多平台分发工具汇总</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-04-16T15:14:19+08:00">
                2024-04-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>文章撰写一次 到处分发 无需繁琐的复制粘贴 节省大量的重复机械劳动力 追求极致的自动化 一键分发工具 无疑是解决了很多创作者的痛点</p>
<p>接下来给大家汇总几个可一键分发的网站</p>
<h2 id="一键分发平台"><a href="#一键分发平台" class="headerlink" title="一键分发平台"></a>一键分发平台</h2><ul>
<li><p><a href="https://mdnice.com/?platform=2" target="_blank" rel="noopener">mdnice</a></p>
<p><img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240418194825613.png" alt="image-20240418194825613"></p>
</li>
<li><p><a href="https://openwrite.cn/" target="_blank" rel="noopener">openwrite</a></p>
<p><img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240417225346730.png" alt="image-20240417225346730"></p>
</li>
</ul>
<p><strong>本文为作者原创 转载时请注明出处 谢谢</strong></p>
<p><img src="https://gitee.com/songjianzaina/SavePicGoPic/raw/master/img/20191119095516.png" alt></p>
<p><em><a href="https://code.newban.cn/">乱码三千 – 点滴积累 ,欢迎来到乱码三千技术博客站</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://code.newban.cn465.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="乱码三千">
      <meta itemprop="description" content>
      <meta itemprop="image" content="images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="乱码三千 – 分享实用IT技术">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="465.html" itemprop="url">使用python3将wordpress博客数据迁移到hexo</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-04-16T12:14:19+08:00">
                2024-04-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>为了追求网站访问的稳定性 准备将<code>wordpress</code>博客迁移到<code>hexo</code>上 考虑到数据量比较多 我直接将数据库导出成压缩包 然后下载到本地电脑 然后使用<code>python</code>批量将里面的文章转成<code>markdown</code>格式的文档</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ol>
<li><p>导出数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -u用户名 -p密码 数据库名 | gzip &gt; 数据库名.sql.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>将导出的数据库文件下载到本地 然后双击解压该数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -r root@服务器IP:刚导出的数据库所在路径 本地目录</span><br></pre></td></tr></table></figure>
</li>
<li><p>数据库导入进本地<code>mysql</code>中 方便<code>python</code>连接</p>
<p>首先创建新数据库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;create database 数据库名;</span><br></pre></td></tr></table></figure>

<p>然后将<code>sql</code>文件导入到该库中:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u用户名 -p密码 数据库名 &lt; 数据库名.sql</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Python批量转换"><a href="#Python批量转换" class="headerlink" title="Python批量转换"></a>Python批量转换</h2><p><code>python</code>代码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##########################</span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment">#  链接本地mysql数据库将wordpress中的文章提取出来并转成hexo博客格式</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">##########################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> markdownify <span class="keyword">import</span> markdownify <span class="keyword">as</span> md</span><br><span class="line"><span class="keyword">import</span> pymysql.cursors</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.setrecursionlimit(<span class="number">1000000</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接数据库</span></span><br><span class="line">conn = pymysql.Connect(</span><br><span class="line">    host=<span class="string">'127.0.0.1'</span>,</span><br><span class="line">    port=<span class="number">3306</span>,</span><br><span class="line">    user=<span class="string">'数据库用户名'</span>,</span><br><span class="line">    passwd=<span class="string">'数据库密码'</span>,</span><br><span class="line">    db=<span class="string">'wordpress_it'</span>,</span><br><span class="line">    charset=<span class="string">'utf8mb4'</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># 获取游标</span></span><br><span class="line">cursor = conn.cursor()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有文章</span></span><br><span class="line">cursor.execute(<span class="string">"SELECT post_title, post_content, post_date FROM wp_posts WHERE post_type='post'"</span>)</span><br><span class="line">posts = cursor.fetchall()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保输出目录存在</span></span><br><span class="line">output_dir = <span class="string">'hexo_posts'</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_dir):</span><br><span class="line">    os.makedirs(output_dir)</span><br><span class="line"></span><br><span class="line">tags=[<span class="string">"Android"</span>,<span class="string">"IOS"</span>,<span class="string">"服务器"</span>,<span class="string">"Docker"</span>,<span class="string">"Mysql"</span>,<span class="string">"Flutter"</span>,<span class="string">"Java"</span>,<span class="string">"Hexo"</span>]</span><br><span class="line">postTag=<span class="string">"技术文章"</span> <span class="comment">#默认分类为</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历每篇文章</span></span><br><span class="line"><span class="keyword">for</span> idx, post <span class="keyword">in</span> enumerate(posts):</span><br><span class="line">    title, content,date = post</span><br><span class="line">    <span class="keyword">for</span> tag <span class="keyword">in</span> tags:</span><br><span class="line">        <span class="keyword">if</span> tag <span class="keyword">in</span> title:</span><br><span class="line">            postTag=tag</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将HTML内容转换为Markdown</span></span><br><span class="line">    markdown_content = md(content)</span><br><span class="line">    <span class="comment"># 写入Hexo格式的Markdown文件</span></span><br><span class="line">    <span class="keyword">with</span> open(os.path.join(output_dir, <span class="string">f"<span class="subst">&#123;idx+<span class="number">1</span>&#125;</span>.md"</span>), <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">"---\n"</span>)</span><br><span class="line">        f.write(<span class="string">f"title: <span class="subst">&#123;title&#125;</span>\n"</span>) <span class="comment"># 如果要嵌入变量 需要加f</span></span><br><span class="line">        f.write(<span class="string">f"date: <span class="subst">&#123;date&#125;</span>\n"</span>)  <span class="comment"># 请将日期替换为实际发布日期</span></span><br><span class="line">        f.write(<span class="string">f"tags: <span class="subst">&#123;postTag&#125;</span>\n"</span>)</span><br><span class="line">        f.write(<span class="string">"---\n"</span>)</span><br><span class="line">        f.write(<span class="string">"\n"</span>)</span><br><span class="line">        f.write(markdown_content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭游标和连接</span></span><br><span class="line">cursor.close()</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>

<p>想要正常运行该代码 需要安装<code>pymysql</code>和<code>markdownify</code>两个库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip3 install markdownify</span><br><span class="line">pip3 install pymysql</span><br></pre></td></tr></table></figure>

<p><strong>本文为作者原创 转载时请注明出处 谢谢</strong></p>
<p><img src="https://gitee.com/songjianzaina/SavePicGoPic/raw/master/img/20191119095516.png" alt></p>
<p><em><a href="https://code.newban.cn/">乱码三千 – 点滴积累 ,欢迎来到乱码三千技术博客站</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://code.newban.cn464.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="乱码三千">
      <meta itemprop="description" content>
      <meta itemprop="image" content="images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="乱码三千 – 分享实用IT技术">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="464.html" itemprop="url">编写一个hexo插件 实现给文章中的外部超链接增加一个中间跳转询问页面</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-04-16T10:14:19+08:00">
                2024-04-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>我本来想让AI给我写一个<code>hexo</code>插件 如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">请写一个hexo插件 要求功能如下:</span><br><span class="line"></span><br><span class="line">1. 在执行hexo -g指令时自动将文章中的非本站合法超链接提取替换出来 为每个合法的链接生成独立的跳转页面  独立页面的地址和链接形成固定的对应关系  不会因为新增文章而发生对应链接改变的问题</span><br><span class="line">2. 当用户浏览博客时点击超链接会跳转到一个单独的网页 在这个网页中显示文字和该链接地址并询问用户是否需要跳转到该链接  当用户点击文字下方的跳转按钮则自动跳转到该链接  </span><br><span class="line">3. 文章中的链接应该替换成对应已经生成的跳转页面的链接 </span><br><span class="line">4. 要求能在`config`文件中自定义需要进行排除的域名 不对排除的域名下的所有链接进行跳转页面的生成 保留原始的直接跳转即可 </span><br><span class="line">5. 在`config`文件中增加插件的开启开关 </span><br><span class="line">6. 需要过滤掉非合法的超链接 非合法的链接不做处理</span><br><span class="line">7. 跳转页面的UI希望能美观一些 内容居中显示 </span><br><span class="line"></span><br><span class="line">请给出插件的完整代码</span><br></pre></td></tr></table></figure>

<p>然后<code>AI</code>给我的答案是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">以下是一个满足您需求的Hexo插件的完整代码：</span><br><span class="line"></span><br><span class="line">const fs = require(&apos;fs&apos;);</span><br><span class="line">const path = require(&apos;path&apos;);</span><br><span class="line">const &#123; promisify &#125; = require(&apos;util&apos;);</span><br><span class="line">const &#123; URL &#125; = require(&apos;url&apos;);</span><br><span class="line"></span><br><span class="line">const readFile = promisify(fs.readFile);</span><br><span class="line">const writeFile = promisify(fs.writeFile);</span><br><span class="line"></span><br><span class="line">const config = hexo.config.external_link_redirect || &#123;&#125;;</span><br><span class="line">const excludedDomains = config.excluded_domains || [];</span><br><span class="line">const redirectPageDir = path.join(hexo.public_dir, &apos;redirect_pages&apos;);</span><br><span class="line">const redirectPageTemplate = `</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">  &lt;title&gt;Redirect Page&lt;/title&gt;</span><br><span class="line">  &lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">      font-family: Arial, sans-serif;</span><br><span class="line">      text-align: center;</span><br><span class="line">    &#125;</span><br><span class="line">    .container &#123;</span><br><span class="line">      margin-top: 100px;</span><br><span class="line">    &#125;</span><br><span class="line">    .link &#123;</span><br><span class="line">      font-size: 18px;</span><br><span class="line">      font-weight: bold;</span><br><span class="line">    &#125;</span><br><span class="line">    .button &#123;</span><br><span class="line">      padding: 10px 20px;</span><br><span class="line">      background-color: #007bff;</span><br><span class="line">      color: #fff;</span><br><span class="line">      border: none;</span><br><span class="line">      border-radius: 5px;</span><br><span class="line">      cursor: pointer;</span><br><span class="line">      text-decoration: none;</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div class=&quot;container&quot;&gt;</span><br><span class="line">    &lt;p class=&quot;link&quot;&gt;%LINK%&lt;/p&gt;</span><br><span class="line">    &lt;button class=&quot;button&quot; onclick=&quot;redirectToLink()&quot;&gt;Go to Link&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;script&gt;</span><br><span class="line">    function redirectToLink() &#123;</span><br><span class="line">      window.location.href = &apos;%URL%&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">`;</span><br><span class="line"></span><br><span class="line">hexo.extend.filter.register(&apos;before_generate&apos;, async function () &#123;</span><br><span class="line">  if (!config.enable) &#123;</span><br><span class="line">    console.log(&apos;External link redirect plugin is disabled.&apos;);</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  await createRedirectPages();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">async function createRedirectPages() &#123;</span><br><span class="line">  const posts = hexo.locals.get(&apos;posts&apos;);</span><br><span class="line">  if (!posts || !posts.length) &#123;</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  for (const post of posts.data) &#123;</span><br><span class="line">    const content = post.content;</span><br><span class="line">    const updatedContent = await processContent(content);</span><br><span class="line">    post.content = updatedContent;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">async function processContent(content) &#123;</span><br><span class="line">  const updatedContent = content.replace(/&lt;a href=&quot;([^&quot;]+)&quot;[^&gt;]*&gt;(.*?)&lt;\/a&gt;/gi, async (match, url, text) =&gt; &#123;</span><br><span class="line">    if (!isLinkValid(url)) &#123;</span><br><span class="line">      return match; // Skip invalid links</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const redirectPagePath = await generateRedirectPage(url);</span><br><span class="line">    const redirectLink = `&lt;a href=&quot;$&#123;redirectPagePath&#125;&quot;&gt;$&#123;text&#125;&lt;/a&gt;`;</span><br><span class="line">    return redirectLink;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  return updatedContent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function isLinkValid(url) &#123;</span><br><span class="line">  if (!url || typeof url !== &apos;string&apos;) &#123;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const parsedUrl = new URL(url);</span><br><span class="line">  const domain = parsedUrl.hostname.replace(&apos;www.&apos;, &apos;&apos;);</span><br><span class="line">  return !excludedDomains.includes(domain);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">async function generateRedirectPage(url) &#123;</span><br><span class="line">  const redirectUrl = new URL(url);</span><br><span class="line">  const domain = redirectUrl.hostname.replace(&apos;www.&apos;, &apos;&apos;);</span><br><span class="line">  const redirectPagePath = path.join(redirectPageDir, `$&#123;domain&#125;_$&#123;Date.now()&#125;.html`);</span><br><span class="line">  const pageContent = redirectPageTemplate.replace(&apos;%LINK%&apos;, url).replace(&apos;%URL%&apos;, url);</span><br><span class="line"></span><br><span class="line">  await writeFile(redirectPagePath, pageContent);</span><br><span class="line">  return redirectPagePath.replace(hexo.public_dir, &apos;&apos;);</span><br><span class="line">&#125;</span><br><span class="line">在这个插件中，我们做了以下几件事情：</span><br><span class="line"></span><br><span class="line">在执行hexo -g指令之前，通过before_generate过滤器来自动生成跳转页面。</span><br><span class="line">通过正则表达式遍历文章内容，找到所有超链接，并检查链接是否有效。</span><br><span class="line">对于有效的链接，创建一个跳转页面，并将原始链接替换为跳转页面的链接。</span><br><span class="line">生成的跳转页面是一个HTML文件，包含跳转链接和一个按钮，点击按钮可以跳转到原始链接。</span><br><span class="line">用户可以在Hexo配置文件中设置插件的开启状态、需要排除的域名以及跳转页面模板。</span><br><span class="line">最终生成的跳转页面保存在public/redirect_pages目录下，每个页面都有固定的对应关系，不会因为新增文章而改变链接。</span><br></pre></td></tr></table></figure>

<p>看了一下AI给我写的代码, 可以说是秀的我头疼, 代码可读性实在太差了, 难道是我问的方式不对?🤔</p>
<p>由于<code>ChatGPT</code>免费次数有限 我也懒得去搜寻免费的<code>AIChat</code>,  干脆就自己手动写一个吧</p>
<p>最后调试完成后的插件代码如下:</p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> cheerio = <span class="built_in">require</span>(<span class="string">'cheerio'</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; log &#125; = <span class="built_in">require</span>(<span class="string">'console'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> DEFAULT_EXCLUDE_DOMAINS = [<span class="string">'example.com'</span>]; <span class="comment">// 默认排除的域名列表</span></span><br><span class="line"></span><br><span class="line">hexo.extend.filter.register(<span class="string">'before_generate'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> config = hexo.config.external_links || &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> excludeDomains = config.exclude_domains || DEFAULT_EXCLUDE_DOMAINS;</span><br><span class="line">    <span class="keyword">if</span> (!config.enable) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'关闭external_links插件'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    hexo.extend.generator.register(<span class="string">'external_links'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">locals</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> posts = locals.posts;</span><br><span class="line">        <span class="keyword">const</span> author = hexo.config.author;</span><br><span class="line">        <span class="keyword">const</span> outputDir = hexo.config.external_links_output || <span class="string">'external_links'</span>;</span><br><span class="line">        <span class="keyword">const</span> linkMap = <span class="keyword">new</span> <span class="built_in">Map</span>(); <span class="comment">// 存储链接和其对应的哈希值的映射</span></span><br><span class="line"></span><br><span class="line">        posts.forEach(<span class="function"><span class="params">post</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> $ = cheerio.load(post.content);</span><br><span class="line">            $(<span class="string">'a'</span>).each(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">const</span> href = filterUrl($(<span class="keyword">this</span>).attr(<span class="string">'href'</span>));</span><br><span class="line">                <span class="keyword">const</span> hostname = getHostname(href);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (hostname!=<span class="string">""</span>&amp;&amp;!excludeDomains.includes(hostname)) &#123;</span><br><span class="line">                    <span class="keyword">const</span> hash = generateHash(href);</span><br><span class="line">                    linkMap.set(href, hash); <span class="comment">// 存储链接和哈希值的映射关系</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//替换文章中的原始链接</span></span><br><span class="line">                    <span class="keyword">const</span> newHref = <span class="string">`/<span class="subst">$&#123;outputDir&#125;</span>/<span class="subst">$&#123;hash&#125;</span>.html`</span>;</span><br><span class="line">                    $(<span class="keyword">this</span>).attr(<span class="string">'href'</span>, newHref);</span><br><span class="line">                    $(<span class="keyword">this</span>).attr(<span class="string">'target'</span>, <span class="string">"blank"</span>);<span class="comment">//在新标签页中打开超链接</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            post.content = $.html();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> outputPath = path.join(hexo.public_dir, outputDir);</span><br><span class="line">        <span class="keyword">if</span> (!fs.existsSync(outputPath)) &#123;</span><br><span class="line">            fs.mkdirSync(outputPath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成每个链接对应的页面</span></span><br><span class="line">        linkMap.forEach(<span class="function">(<span class="params">hash, href</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> htmlContent = generateLinkPage(href, hash,author);</span><br><span class="line">            <span class="keyword">const</span> outputFile = path.join(outputPath, <span class="string">`<span class="subst">$&#123;hash&#125;</span>.html`</span>);</span><br><span class="line">            fs.writeFileSync(outputFile, htmlContent);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateLinkPage</span>(<span class="params">href, hash,author</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> html = <span class="string">`</span></span><br><span class="line"><span class="string">        &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">        &lt;html lang="en"&gt;</span></span><br><span class="line"><span class="string">        &lt;head&gt;</span></span><br><span class="line"><span class="string">            &lt;meta charset="UTF-8"&gt;</span></span><br><span class="line"><span class="string">            &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</span></span><br><span class="line"><span class="string">            &lt;title&gt;访问外部网站-&#123;author&#125;&lt;/title&gt;</span></span><br><span class="line"><span class="string">            &lt;style&gt;</span></span><br><span class="line"><span class="string">                body &#123;</span></span><br><span class="line"><span class="string">                    margin: 20px;</span></span><br><span class="line"><span class="string">                    padding-top: 100px;</span></span><br><span class="line"><span class="string">                    color: #222;</span></span><br><span class="line"><span class="string">                    font-size: 13px;</span></span><br><span class="line"><span class="string">                    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;</span></span><br><span class="line"><span class="string">                    line-height: 1.5;</span></span><br><span class="line"><span class="string">                    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                .wrapper &#123;</span></span><br><span class="line"><span class="string">                    margin: auto;</span></span><br><span class="line"><span class="string">                    padding-left: 30px;</span></span><br><span class="line"><span class="string">                    padding-right: 30px;</span></span><br><span class="line"><span class="string">                    max-width: 540px;</span></span><br><span class="line"><span class="string"> 									  padding-top: 25px;</span></span><br><span class="line"><span class="string">                    padding-bottom: 25px;</span></span><br><span class="line"><span class="string">                    background-color: #f7f7f7;</span></span><br><span class="line"><span class="string">                    border: 1px solid #babbbc;</span></span><br><span class="line"><span class="string">                    border-radius: 5px;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">             </span></span><br><span class="line"><span class="string">              </span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">                .button &#123;</span></span><br><span class="line"><span class="string">                    padding: 0;</span></span><br><span class="line"><span class="string">                    font-family: inherit;</span></span><br><span class="line"><span class="string">                    background: none;</span></span><br><span class="line"><span class="string">                    border: none;</span></span><br><span class="line"><span class="string">                    outline: none;</span></span><br><span class="line"><span class="string">                    cursor: pointer;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                .button:hover &#123;</span></span><br><span class="line"><span class="string">                    background-color: #0070cd;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                a&#123;</span></span><br><span class="line"><span class="string">                    text-decoration: none</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">                .button:active &#123;</span></span><br><span class="line"><span class="string">                    background-color: #0077d9;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">          </span></span><br><span class="line"><span class="string">                .link &#123;</span></span><br><span class="line"><span class="string">                    margin-bottom: 10px;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">              </span></span><br><span class="line"><span class="string">                .button &#123;</span></span><br><span class="line"><span class="string">                    display: inline-block;</span></span><br><span class="line"><span class="string">                    padding: 10px 16px;</span></span><br><span class="line"><span class="string">                    color: #fff;</span></span><br><span class="line"><span class="string">                    font-size: 14px;</span></span><br><span class="line"><span class="string">                    line-height: 1;</span></span><br><span class="line"><span class="string">                    background-color: #0077d9;</span></span><br><span class="line"><span class="string">                    border-radius: 3px;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                .actions &#123;</span></span><br><span class="line"><span class="string">                    margin-top: 15px;</span></span><br><span class="line"><span class="string">                    padding-top: 30px;</span></span><br><span class="line"><span class="string">                    text-align: right;</span></span><br><span class="line"><span class="string">                    border-top: 1px solid #d8d8d8;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &lt;/style&gt;</span></span><br><span class="line"><span class="string">        &lt;/head&gt;</span></span><br><span class="line"><span class="string">        &lt;body&gt;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">            &lt;div class="wrapper"&gt;</span></span><br><span class="line"><span class="string">                &lt;div class="content"&gt;</span></span><br><span class="line"><span class="string">                    &lt;h1&gt;即将离开<span class="subst">$&#123;author&#125;</span>&lt;/h1&gt;</span></span><br><span class="line"><span class="string">                    &lt;p class="info"&gt;您即将离开<span class="subst">$&#123;author&#125;</span>，前往外部网站。&lt;/p&gt;</span></span><br><span class="line"><span class="string">                    &lt;p class="link"&gt;<span class="subst">$&#123;href&#125;</span>&lt;/p&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div class="actions"&gt;</span></span><br><span class="line"><span class="string">                    &lt;a class="button" href="<span class="subst">$&#123;href&#125;</span>" one-link-mark="yes"&gt;继续访问&lt;/a&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line">    <span class="keyword">return</span> html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getHostname</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> URL(url).hostname;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filterUrl</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> urlRegex = <span class="regexp">/http[s]?:\/\/[\u4e00-\u9fa5\w.-\/:]+[\u4e00-\u9fa5\w.?&amp;\/=-]+/g</span>;</span><br><span class="line">    <span class="keyword">const</span> match = urlRegex.exec(url);</span><br><span class="line">    <span class="keyword">return</span> match ? match[<span class="number">0</span>] : <span class="string">''</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateHash</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> crypto.createHash(<span class="string">'md5'</span>).update(data).digest(<span class="string">'hex'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用方法:</strong></p>
<p>在<code>script</code>目录下新建一个<code>js</code>文件,  注意名称不要使用<code>index.js</code>, 将上面代码粘贴过去, 然后在<code>config</code>配置文件中指定输出的目录以及需要过滤的域名 如下:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#需要排除的域名 以及是否开启该插件</span></span><br><span class="line"><span class="attr">external_links:</span></span><br><span class="line"><span class="attr">  exclude_domains:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'acg.newban.cn'</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'newban.cn'</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'code.newban.cn'</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'audio.newban.cn'</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#输出目录</span></span><br><span class="line"><span class="attr">external_links_output:</span> <span class="string">external_links</span></span><br></pre></td></tr></table></figure>

<h2 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h2><p>模仿的知乎效果:</p>
<p><img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240416141911249.png" alt="image-20240416141911249"></p>
<p><strong>本文为作者原创 转载时请注明出处 谢谢</strong></p>
<p><img src="https://gitee.com/songjianzaina/SavePicGoPic/raw/master/img/20191119095516.png" alt></p>
<p><em><a href="https://code.newban.cn/">乱码三千 – 点滴积累 ,欢迎来到乱码三千技术博客站</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://code.newban.cn463.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="乱码三千">
      <meta itemprop="description" content>
      <meta itemprop="image" content="images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="乱码三千 – 分享实用IT技术">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="463.html" itemprop="url">数据库常用操作指令</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-04-15T10:14:19+08:00">
                2024-04-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>数据库操作指令<em></em>涵盖了创建、查询、修改和删除数据库及表的过程，以及如何在这些数据库和表中进行数据操作。以下是一些常用的数据库操作指令：</p>
<h2 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h2><h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> 数据库名;</span><br></pre></td></tr></table></figure>

<h3 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">database</span> 数据库名;</span><br></pre></td></tr></table></figure>

<h3 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> 表名 (列名 数据类型);</span><br></pre></td></tr></table></figure>

<h3 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> 表名;</span><br></pre></td></tr></table></figure>

<h3 id="显示所有数据库"><a href="#显示所有数据库" class="headerlink" title="显示所有数据库"></a>显示所有数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">databases</span>;</span><br></pre></td></tr></table></figure>

<h3 id="进入数据库"><a href="#进入数据库" class="headerlink" title="进入数据库"></a>进入数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> 数据库名;</span><br></pre></td></tr></table></figure>

<h3 id="显示所有表"><a href="#显示所有表" class="headerlink" title="显示所有表"></a>显示所有表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span>;</span><br></pre></td></tr></table></figure>

<h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名 <span class="keyword">values</span>(值<span class="number">1</span>,值<span class="number">2</span>,...);</span><br></pre></td></tr></table></figure>

<h3 id="修改数据"><a href="#修改数据" class="headerlink" title="修改数据"></a>修改数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> 表名 <span class="keyword">set</span> 字段=新值 <span class="keyword">where</span> 条件;</span><br></pre></td></tr></table></figure>

<h3 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> 表名 <span class="keyword">where</span> 条件;</span><br></pre></td></tr></table></figure>

<h3 id="修改表名"><a href="#修改表名" class="headerlink" title="修改表名"></a>修改表名</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 旧表名 <span class="keyword">rename</span> <span class="keyword">to</span> 新表名;</span><br></pre></td></tr></table></figure>

<h3 id="查看表所有的字段"><a href="#查看表所有的字段" class="headerlink" title="查看表所有的字段"></a>查看表所有的字段</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">describe</span> 表名</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">columns</span> <span class="keyword">from</span> 表名</span><br></pre></td></tr></table></figure>

<h3 id="添加字段"><a href="#添加字段" class="headerlink" title="添加字段"></a>添加字段</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">add</span> 字段名 数据类型;</span><br></pre></td></tr></table></figure>

<h3 id="修改字段"><a href="#修改字段" class="headerlink" title="修改字段"></a>修改字段</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">modify</span> 字段名 新数据类型;</span><br></pre></td></tr></table></figure>

<h3 id="删除字段"><a href="#删除字段" class="headerlink" title="删除字段"></a>删除字段</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">drop</span> 字段名;</span><br></pre></td></tr></table></figure>

<p>这些指令提供了对数据库和表的基本操作，包括创建、修改、删除和查询数据 根据具体需求，可以组合使用这些指令来完成更复杂的数据库管理任务</p>
<p><strong>本文为作者原创 转载时请注明出处 谢谢</strong></p>
<p><img src="https://gitee.com/songjianzaina/SavePicGoPic/raw/master/img/20191119095516.png" alt></p>
<p><em><a href="https://code.newban.cn/">乱码三千 – 点滴积累 ,欢迎来到乱码三千技术博客站</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://code.newban.cn460.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="乱码三千">
      <meta itemprop="description" content>
      <meta itemprop="image" content="images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="乱码三千 – 分享实用IT技术">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="460.html" itemprop="url">Mac平台如何下载ffmpeg并对m3u8视频进行下载转换成MP4</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-04-13T10:14:19+08:00">
                2024-04-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ffmpeg安装"><a href="#ffmpeg安装" class="headerlink" title="ffmpeg安装"></a>ffmpeg安装</h2><p>在Mac平台上 本人多次使用<code>brew</code>工具进行<code>ffmpeg</code>安装都未成功</p>
<p>于是决定直接去<code>ffmpeg</code>官网下载执行包</p>
<p><a href="http://www.ffmpeg.org/download.html" target="_blank" rel="noopener">点击进入官网</a></p>
<p>由于是国外的网站 下载速度会相对较慢 文末已经给大家准备了网盘下载链接</p>
<p>这里我们选择<code>Mac</code> :</p>
<p><img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240413173518406.png" alt="image-20240413173518406"></p>
<p><img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240413173539785.png" alt="image-20240413173539785"></p>
<p><img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240413173602675.png" alt="image-20240413173602675"></p>
<p>将执行压缩包解压后得到一个独立的<code>ffmpeg</code>执行文件:</p>
<p><img src="https://gitee.com/songjianzaina/site_img/raw/master/img/image-20240413173929604.png" alt="image-20240413173929604"></p>
<p>为了方便我们接下来的使用 需要对其进行环境变量的配置:</p>
<ol>
<li><p>在终端中输入以下命令 打开环境变量配置文件：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.bash_profile</span><br></pre></td></tr></table></figure>
</li>
<li><p>在该文件中加入以下内容</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="string">"/path/to/ffmpeg:<span class="variable">$PATH</span>"</span></span><br></pre></td></tr></table></figure>

<p> 注意: 这里需要将 <code>/path/to/ffmpeg</code> 替换为你的<code>ffmpeg</code>所在路径</p>
</li>
</ol>
<ol start="3">
<li><p>使用<code>source</code>命令使新的环境变量生效</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证是否配置成功</p>
<p>在任意一个非ffmpeg所在目录执行以下命令, 如果正常打印内容 则代表配置成功:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -version</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h2 id="下载m3u8视频并转换成mp4"><a href="#下载m3u8视频并转换成mp4" class="headerlink" title="下载m3u8视频并转换成mp4"></a>下载m3u8视频并转换成mp4</h2><p><code>ffmpeg</code>支持直接访问<code>m3u8</code>链接并将其内容转成mp4格式, 执行命令如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i &#123;m3u8链接&#125; -c copy -bsf:a aac_adtstoasc &#123;文件名&#125;.mp4</span><br></pre></td></tr></table></figure>

<p>同样的该<code>ffmpeg</code>指令也适用于直播流的下载和转换 比如<code>http://xxx.flv</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i &#123;直播链接&#125; -c copy -bsf:a aac_adtstoasc &#123;文件名&#125;.mp4</span><br></pre></td></tr></table></figure>

<h2 id="ffmpeg国内下载"><a href="#ffmpeg国内下载" class="headerlink" title="ffmpeg国内下载"></a>ffmpeg国内下载</h2><p><a href="https://url97.ctfile.com/d/21042697-59243365-19e46d?p=312306" target="_blank" rel="noopener">网盘下载</a> (访问密码: 312306)</p>
<p><strong>本文为作者原创 转载时请注明出处 谢谢</strong></p>
<p><img src="https://gitee.com/songjianzaina/SavePicGoPic/raw/master/img/20191119095516.png" alt></p>
<p><em><a href="https://code.newban.cn/">乱码三千 – 点滴积累 ,欢迎来到乱码三千技术博客站</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://code.newban.cn461.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="乱码三千">
      <meta itemprop="description" content>
      <meta itemprop="image" content="images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="乱码三千 – 分享实用IT技术">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="461.html" itemprop="url">使用ffmpeg将本地的flv视频压制转换成小体积的MP4</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-04-13T10:14:19+08:00">
                2024-04-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>关于<code>ffmpeg</code>的下载, 可查阅上一篇文章《<a href="https://code.newban.cn/460.html">Mac平台如何下载ffmpeg并对m3u8视频进行下载转换成MP4</a>》</p>
<p>本文将给大家介绍如何使用<code>ffmpeg</code>将本地的<code>flv</code>视频压制转换成小体积的<code>MP4</code></p>
<h2 id="格式转换"><a href="#格式转换" class="headerlink" title="格式转换"></a>格式转换</h2><p>如果只是单纯的进行格式转换 可以直接使用以下指令来实现:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.flv -vcodec copy -acodec copy output.mp4</span><br></pre></td></tr></table></figure>

<p>这种方式通常体积不会有太大的改变 </p>
<h2 id="转换格式并压缩视频体积"><a href="#转换格式并压缩视频体积" class="headerlink" title="转换格式并压缩视频体积"></a>转换格式并压缩视频体积</h2><p>如果需要将视频进行压缩 以减少空间的占用 可以参考以下指令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.flv -c:v libx264 -crf 26 -c:a aac -strict experimental -b:a 128k output.mp4</span><br></pre></td></tr></table></figure>

<p><strong>解释各选项含义：</strong></p>
<ul>
<li><code>-i input.flv</code>：指定输入文件名为<code>input.flv</code>。</li>
<li><code>-c:v libx264</code>：使用<code>H.264</code>编码来压缩视频。</li>
<li><code>-crf 28</code>：设置<code>CRF</code>（常量速率因子）的值为23。低值表示更好的质量，但文件会更大；高值会降低质量。范围是从0（无损）到51（最糟），通常使用18到28, <code>27</code>通常是用于<code>MP4</code>格式的视频质量很好的平衡</li>
<li><code>-c:a aac</code>：使用<code>AAC</code>编码来压缩音频。</li>
<li><code>-strict experimental</code>：允许使用实验性的编码器。</li>
<li><code>-b:a 128k</code>：设置音频比特率为128k。根据需求可以调整大小。</li>
</ul>
<p>我们需要找到一个合适的参数平衡点 确保视频画面的质量的同时尽可能地压缩视频体积</p>
<p>如果我们想要快速压制 减少等待时间 还可以指定编码器预设 如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.flv -c:v libx264 -preset veryfast -crf 24 -c:a aac -b:a 128k output.mp4</span><br></pre></td></tr></table></figure>

<p><strong>解释选项含义：</strong></p>
<ul>
<li><code>-preset veryfast</code>：指定编码器预设，<code>veryfast</code>提供快速但质量较低的编码, 除此之外 还有<code>fast</code>、<code>HQ</code>、 <code>SuperHQ</code>等预设。</li>
</ul>
<h2 id="ffmpeg-截取视频"><a href="#ffmpeg-截取视频" class="headerlink" title="ffmpeg 截取视频"></a>ffmpeg 截取视频</h2><p>要使用<code>FFmpeg</code>截取视频 可以使用以下指令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.mp4 -ss 00:00:10 -t 00:00:30 -c copy output.mp4</span><br></pre></td></tr></table></figure>

<p><strong>解释各选项含义：</strong></p>
<ul>
<li><code>-i input.mp4</code> 指定输入视频文件。</li>
<li><code>-ss 00:00:10</code> 表示从视频的指定时间点开始截取，这里是从10秒处开始。</li>
<li><code>-t 00:00:30</code> 表示截取的时长，这里是30秒。</li>
<li><code>-c copy</code> 表示复制编码器，即不重新编码，直接复制视频流和音频流。</li>
<li><code>output.mp4</code> 是输出文件的名称。</li>
</ul>
<p>请根据实际需求调整时间参数。如果需要不同的起始时间或时长，只需修改<code>-ss</code>和<code>-t</code>参数即可。如果需要对视频进行重编码，可以去掉<code>-c copy</code>参数或指定其他编码器选项。</p>
<p><strong>本文为作者原创 转载时请注明出处 谢谢</strong></p>
<p><img src="https://gitee.com/songjianzaina/SavePicGoPic/raw/master/img/20191119095516.png" alt></p>
<p><em><a href="https://code.newban.cn/">乱码三千 – 点滴积累 ,欢迎来到乱码三千技术博客站</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://code.newban.cn462.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="乱码三千">
      <meta itemprop="description" content>
      <meta itemprop="image" content="images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="乱码三千 – 分享实用IT技术">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="462.html" itemprop="url">如何开发hexo插件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-04-13T10:14:19+08:00">
                2024-04-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Hexo 有强大的插件系统，使您能轻松扩展功能而不用修改核心模块的源码。在 Hexo 中有两种形式的插件：</p>
<h3 id="脚本（Scripts）"><a href="#脚本（Scripts）" class="headerlink" title="脚本（Scripts）"></a>脚本（Scripts）</h3><p>如果您的代码很简单，建议您编写脚本，您只需要把 JavaScript 文件放到 <code>scripts</code> 文件夹，在启动时就会自动加载。</p>
<h3 id="插件（Packages）"><a href="#插件（Packages）" class="headerlink" title="插件（Packages）"></a>插件（Packages）</h3><p>如果您的代码较复杂，或是您想要发布到 NPM 上，建议您编写插件。首先，在 <code>node_modules</code> 文件夹中建立文件夹，文件夹名称开头必须为 <code>hexo-</code>，如此一来 Hexo 才会在启动时加载；否则 Hexo 将会忽略它。</p>
<p>文件夹内至少要包含 2 个文件：一个是主程序，另一个是 <code>package.json</code>，描述插件的用途和所依赖的插件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── index.js</span><br><span class="line">└── package.json</span><br></pre></td></tr></table></figure>

<p><code>package.json</code> 中至少要包含 <code>name</code>, <code>version</code>, <code>main</code> 属性，例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package.json&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"hexo-my-plugin"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"0.0.1"</span>,</span><br><span class="line">  <span class="string">"main"</span>: <span class="string">"index"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><p>您可以使用 Hexo 提供的官方工具插件来加速开发：</p>
<ul>
<li><a href="https://github.com/hexojs/hexo-fs" target="_blank" rel="noopener">hexo-fs</a>：文件 IO</li>
<li><a href="https://github.com/hexojs/hexo-util" target="_blank" rel="noopener">hexo-util</a>：工具程式</li>
<li><a href="https://github.com/hexojs/hexo-i18n" target="_blank" rel="noopener">hexo-i18n</a>：本地化（i18n）</li>
<li><a href="https://github.com/hexojs/hexo-pagination" target="_blank" rel="noopener">hexo-pagination</a>：生成分页数据</li>
</ul>
<h3 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h3><p>当您完成插件后，可以考虑将它发布到 <a href="https://hexo.io/plugins" target="_blank" rel="noopener">插件列表</a>，让更多人能够使用您的插件。发布插件的步骤和 <a href="https://hexo.io/zh-cn/docs/contributing.html#更新文档" target="_blank" rel="noopener">更新文档</a> 非常类似。</p>
<ol>
<li><p>Fork <a href="https://github.com/hexojs/site" target="_blank" rel="noopener">hexojs/site</a></p>
</li>
<li><p>把库（repository）复制到电脑上，并安装所依赖的插件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/&lt;username&gt;/site.git</span><br><span class="line">$ <span class="built_in">cd</span> site</span><br><span class="line">$ npm install</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 <code>source/_data/plugins/</code> 中创建一个新的 yaml 文件，使用您的插件名称作为文件名。</p>
</li>
<li><p>编辑 <code>source/_data/plugins/&lt;your-plugin-name&gt;.yml</code> 并添加您的插件。例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">description:</span> <span class="string">Server</span> <span class="string">module</span> <span class="string">for</span> <span class="string">Hexo.</span></span><br><span class="line"><span class="attr">link:</span> <span class="attr">https://github.com/hexojs/hexo-server</span></span><br><span class="line"><span class="attr">tags:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">official</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">server</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">console</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>推送（push）分支。</p>
</li>
<li><p>建立一个新的合并申请（pull request）并描述改动。</p>
</li>
</ol>
<p><strong>本文转载自</strong> : <a href="https://hexo.io/zh-cn/docs/plugins" target="_blank" rel="noopener">Hexo中文网</a></p>
<p><img src="https://gitee.com/songjianzaina/SavePicGoPic/raw/master/img/20191119095516.png" alt></p>
<p><em><a href="https://code.newban.cn/">乱码三千 – 点滴积累 ,欢迎来到乱码三千技术博客站</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="page/47/">47</a><a class="extend next" rel="next" href="page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">乱码三千</p>
              <p class="site-description motion-element" itemprop="description">android程序员一枚,擅长java,kotlin,python,金融投资,欢迎交流~</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="https://code.newban.cn/archives/">
              
                  <span class="site-state-item-count">469</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">138</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">乱码三千</span>
  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




  <script type="text/javascript" async src="js/src/mermaid.min.js"></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: 'default',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  
        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    
      <style>
        a.gitment-editor-footer-tip { display: none; }
        .gitment-container.gitment-footer-container { display: none; }
      </style>
    

    







  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
